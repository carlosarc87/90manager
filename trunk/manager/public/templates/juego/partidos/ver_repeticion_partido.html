{% extends "base.html" %}

{% block css_extra %}
	<link rel="stylesheet" href="/media/css/tablas.css" type="text/css" />
    <link rel="stylesheet" href="/media/css/juego/partidos/ver_repeticion_partido.css" type="text/css" media="screen" />
{% endblock %}

{% block js_extra %}
	<script type="text/javascript">
		// Calcula el tiempo dependiendo de num1 y num2
		function calcularTiempo(segundos, num1, num2) {
			s = ((Math.floor(segundos / num1)) % num2).toString();
			if (s.length < 2)
				s = "0" + s;
			return s;
		}
		
		var velocidad = 10;

		var array_sucesos = [];

		var segundos = 0;
		var pausa = false;
		var fin_partido = true;
		var goles = [];

		function inicializarArraySucesos() {
			array_sucesos = [];
			{% for suceso in sucesos %}
				datos_suceso = [];
				datos_suceso.push("{{ suceso.segundo_partido }}");
				datos_suceso.push(calcularTiempo({{ suceso.segundo_partido }}, 60, 999) + ":" + calcularTiempo({{ suceso.segundo_partido }}, 1, 60));
				datos_suceso.push("{{ suceso.equipo.siglas }}");
				datos_suceso.push("{{ suceso.getTexto }}");
				array_sucesos.push(datos_suceso);
			{% endfor %}
		}

		// Actualiza el mensaje de tiempo
		function actualizarTiempo() {
			str_tiempo = formato_tiempo.replace(/%%M%%/g, calcularTiempo(segundos, 60, 400));
			str_tiempo = str_tiempo.replace(/%%S%%/g, calcularTiempo(segundos, 1, 60));
			document.getElementById("contador_tiempo").innerHTML = str_tiempo;
			annadirFila();
		}
		
		function actualizarVelocidad() {
			document.getElementById("velocidad_tiempo").innerHTML = "x" + (velocidad / 10);
		}

		function contadorTiempo() {
			if (pausa == false && fin_partido == false)
			{
				setTimeout("contadorTiempo()", timeout);
				segundos += paso;
				actualizarTiempo();
			}
		}

		formato_tiempo = "%%M%%:%%S%%";
		paso = 1; // Tiempo en segundos para refrescar

		var timeout = 990;
		var ultimaFilaAgregada = -1;
		
		// Aumentar la velocidad del tiempo de avance de los sucesos
		function incrementarVelocidad() {
			if (velocidad < 20) {
				velocidad = velocidad + 1;
			}
			else if (velocidad < 100) {
				velocidad = velocidad + 10;
			}
			actualizarVelocidad();
			
			timeout = (1 / velocidad) * 1000;
		}
		
		// Dcrementar la velocidad del tiempo de avance de los sucesos
		function decrementarVelocidad() {
			if (velocidad > 20) {
				velocidad = velocidad - 10;
			}
			else if (velocidad > 1) {
				velocidad = velocidad - 1;
			}
			actualizarVelocidad();
			
			timeout = (1 / velocidad) * 1000;
		}

		// Reiniciar sucesos
		function reiniciarContador() {
			segundos = 0;
			goles = [];
			goles.push(0);
			goles.push(0);
			document.getElementById("goles_local").innerHTML = goles[0];
			document.getElementById("goles_visitante").innerHTML = goles[1];
			inicializarArraySucesos();
			ultimaFilaAgregada = -1;
			tabla = document.getElementById("tabla_sucesos");
			while (tabla.rows.length > 0) {
				tabla.deleteRow(0)
			}
			if (fin_partido) {
				fin_partido = false;
				contadorTiempo();
			}
			actualizarTiempo();
		}

		function analizar(suceso) {
			if (suceso[3] == 666) { // Gol
				if (suceso[2] == "{{ siglas_local }}") {
					goles[0] += 1;
					document.getElementById("goles_local").innerHTML = goles[0];
				} else {
					goles[1] += 1;
					document.getElementById("goles_visitante").innerHTML = goles[1];
				}
			}
		}

		function annadirFila() {
			if (ultimaFilaAgregada + 1 < array_sucesos.length) {
				suceso = array_sucesos[ultimaFilaAgregada + 1];
				tiempo = suceso[0];
				while (segundos >= tiempo && !fin_partido) {
					// Analizar el suceso
					analizar(suceso);
					// Incrustarlo en la tabla
					document.getElementById("tabla_sucesos").insertRow(0);
					fila_dest = document.getElementById("tabla_sucesos").rows.item(0);
					for (i = 0; i < suceso.length; i++) {
						fila_dest.insertCell(i);
						fila_dest.cells.item(i).innerHTML = suceso[i];
					}
					ultimaFilaAgregada++;
					if (ultimaFilaAgregada + 1 < array_sucesos.length) {
						suceso = array_sucesos[ultimaFilaAgregada + 1];
						tiempo = suceso[0];
					} else {
						fin_partido = true;
					}
				}
			} else {
				fin_partido = true;
			}
		}

		// Pausar / quitar pausa de la repeticion
		function pausarContador() {
			pausa = !pausa;
			if (pausa == false) {
				contadorTiempo();
			}
		}
		
		/* Para el funcionamiento de tema css con jquery */
		$(function() {
			$( "#beginning" ).button({
				text: false,
				icons: {
					primary: "ui-icon-seek-start"
				}
			});
			
			$( "#play" ).button({
				text: false,
				icons: {
					primary: "ui-icon-play"
				}
			})
			.click(function() {
				var options;
				if ( $( this ).text() === "play" ) {
					options = {
						label: "pause",
						icons: {
							primary: "ui-icon-pause"
						}
					};
				} else {
					options = {
						label: "play",
						icons: {
							primary: "ui-icon-play"
						}
					};
				}
				$( this ).button( "option", options );
			});
			
			$( "#stop" ).button({
				text: false,
				icons: {
					primary: "ui-icon-stop"
				}
			})
			.click(function() {
				$( "#play" ).button( "option", {
					label: "play",
					icons: {
						primary: "ui-icon-play"
					}
				});
			});
			
			$( "#dec_vel" ).button({
				text: false,
				icons: {
					primary: "ui-icon-minus"
				}
			});
			
			$( "#inc_vel" ).button({
				text: false,
				icons: {
					primary: "ui-icon-plus"
				}
			});
			
			$( "#end" ).button({
				text: false,
				icons: {
					primary: "ui-icon-seek-end"
				}
			});
		});
	</script>
{% endblock %}

{% block contenido %}
	<!-- Barra extra prueba -->
	<div id="barra_repeticion" class="ui-widget-header ui-corner-all">
		<button id="beginning" onclick="pausarContador();">Ir al inicio</button>
		<button id="play" onclick="reiniciarContador();">Iniciar</button>
		<button id="stop" onclick="pausarContador();">Parar</button>
		<button id="end" onclick="pausarContador();">Ir al final</button>
		
		<div id="contador_tiempo">00:00</div>
		<div id="velocidad_tiempo">x1</div>
		
		<button id="dec_vel" onclick="decrementarVelocidad();">Decrementar velocidad</button>
		<button id="inc_vel" onclick="incrementarVelocidad();">Aumentar velocidad</button>
	</div>
	
	<table class="tabla1" id="tabla_resultado">
		<caption>Resultado</caption>

		<tbody>
			<tr>
				<td id="col_local">{{ siglas_local }}</td>
				<td id="col_resultado"><span id="goles_local">0</span> - <span id="goles_visitante">0</span></td>
				<td id="col_visitante">{{ siglas_visitante }}</td>
			</tr>
		</tbody>
	</table>
	
	<!-- Sucesos -->
	<table class="tabla1" id="tabla_sucesos">
		<caption>Sucesos</caption>
		<tbody>
		</tbody>
	</table>
{% endblock %}
