# -*- coding: utf-8 -*-
"""
Copyright 2017 by
    * Juan Miguel Lechuga Pérez
    * Jose Luis López Pino
    * Carlos Antonio Rivera Cabello

 This file is part of 90Manager.

    90Manager is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    90Manager is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with 90Manager.  If not, see <http://www.gnu.org/licenses/>.

"""

# Vistas del sistema
from django.contrib.auth.decorators import login_required

from models import Equipo
from forms import EquipoForm

from gestion_sistema.decorators import actualizarLiga, comprobarSesion

from gestion_base.func import devolverMensaje, redireccionar, generarPagina

from gestion_sistema.gestion_liga.models import Liga
from gestion_sistema.gestion_jugador.models import Jugador
from gestion_sistema.gestion_jugador.func import nombreJugadorAleatorio

########################################################################

@login_required
def ver_equipo_id(request, equipo_id):
	''' Muestra los datos de un equipo '''
	# Obtenemos el usuario
	equipos = Equipo.objects.filter(id = equipo_id)

	if equipos.count() == 0:
		return devolverMensaje(request, "Error, no existe un equipo con identificador %s" % equipo_id, 0)

	# Obtenemos el equipo
	request.session['equipo_actual'] = equipos[0]

	return redireccionar("/equipos/ver")

########################################################################

@login_required
@actualizarLiga
@comprobarSesion(['equipo_actual'])
def ver_equipo(request):
	''' Muestra los datos de un equipo '''
	# Obtenemos el usuario
	usuario = request.user

	equipo = request.session['equipo_actual']
	
	if not 'liga_actual' in request.session:
		request.session['liga_actual'] = equipo.liga

	# Obtenemos los jugadores
	jugadores = equipo.getJugadores()

	# Obtener datos de los jugadores
	suma_edad = 0
	suma_nivel = 0
	valor_equipo = 0
	for jugador in jugadores:
		# Valor total del equipo
		valor_equipo += jugador.valorMercado()

		# Edad del equipo
		jugador.anios, jugador.dias = jugador.getEdad()
		jugador.nivel = jugador.getNivel()
		suma_nivel = suma_nivel + jugador.nivel
		suma_edad = suma_edad + jugador.anios + (jugador.dias / 365.0)

	if len(jugadores) > 0:
		edad_media_equipo = "%.2f" % ((suma_edad * 1.0) / len(jugadores))
		nivel_medio_equipo = "%.2f" % ((suma_nivel * 1.0) / len(jugadores))
	else:
		edad_media_equipo = 0
		nivel_medio_equipo = 0

	# Obtenemos la liga
	liga = equipo.liga

	d = {"usuario" : usuario,
		 "liga" : liga,
		 "equipo" : equipo,
		 "jugadores" : jugadores,
		 "valor_equipo" : valor_equipo,
		 "edad_media_equipo" : edad_media_equipo,
		 "nivel_medio_equipo" : nivel_medio_equipo
		}
	return generarPagina(request, "juego/equipos/ver_equipo.html", d)

########################################################################

@login_required
@actualizarLiga
@comprobarSesion(['equipo_propio'])
def ver_equipo_propio(request):
	''' Muestra los datos de un equipo '''
	# Obtenemos el usuario
	usuario = request.user

	equipo = request.session['equipo_propio']

	# Obtenemos los jugadores
	jugadores = equipo.getJugadores()

	# Obtener datos de los jugadores
	suma_edad = 0
	suma_nivel = 0
	valor_equipo = 0
	for jugador in jugadores:
		# Valor total del equipo
		valor_equipo += jugador.valorMercado()

		# Edad del equipo
		jugador.anios, jugador.dias = jugador.getEdad()
		jugador.nivel = jugador.getNivel()
		suma_nivel = suma_nivel + jugador.nivel
		suma_edad = suma_edad + jugador.anios + (jugador.dias / 365.0)

	if len(jugadores) > 0:
		edad_media_equipo = "%.2f" % ((suma_edad * 1.0) / len(jugadores))
		nivel_medio_equipo = "%.2f" % ((suma_nivel * 1.0) / len(jugadores))
	else:
		edad_media_equipo = 0
		nivel_medio_equipo = 0

	# Obtenemos la liga
	liga = equipo.liga

	d = {"usuario" : usuario,
		 "liga" : liga,
		 "equipo" : equipo,
		 "jugadores" : jugadores,
		 "valor_equipo" : valor_equipo,
		 "edad_media_equipo" : edad_media_equipo,
		 "nivel_medio_equipo" : nivel_medio_equipo
		}
	return generarPagina(request, "juego/equipos/ver_equipo.html", d)

########################################################################

@login_required
@actualizarLiga
@comprobarSesion(['liga_actual'])
def crear_equipo(request):
	from gestion_sistema.gestion_equipo.func import ObtenerNombreYSiglasAleatorio

	''' Muestra la pagina para crear un equipo '''
	usuario = request.user

	liga = request.session['liga_actual']

	if liga.activada():
		return devolverMensaje(request, "Esta liga ya no acepta mas equipos", 0, "/ligas/ver/%d/" % liga.id)

	if liga.equipo_set.count() > liga.num_equipos:
		return devolverMensaje(request, "Esta liga ya está llena", 0, "/ligas/ver/%d/" % liga.id)

	if liga.equipo_set.filter(usuario = usuario).count() > 0:
		return devolverMensaje(request, "Ya tienes un equipo en esta liga", 0, "/ligas/ver/%d/" % liga.id)

	if request.method == 'POST':
		form = EquipoForm(liga, request.POST)
		if form.is_valid():
			equipo = form.save(commit = False)
			equipo.usuario = usuario
			equipo.liga = liga
			equipo.dinero = liga.dinero_inicial
			equipo.save()
			equipo.generarJugadoresAleatorios(liga.sexo_permitido, liga.num_jugadores_inicial, liga.nivel_max_jugadores_inicio)
			return devolverMensaje(request, "Se ha creado correctamente", 1, "/equipos/ver/%d/" % equipo.id)
	else:
		form = EquipoForm(liga)

	nombre_aleatorio, siglas = ObtenerNombreYSiglasAleatorio(liga)

	d = {"form": form, "usuario" : usuario, "liga" : liga, "nombre_aleatorio" : nombre_aleatorio, "siglas" : siglas }
	return generarPagina(request, "juego/equipos/crear_equipo.html", d)

########################################################################

@login_required
@actualizarLiga
@comprobarSesion(['liga_actual', 'equipo_propio'])
def listar_equipos_liga(request):
	""" Muestra los equipos de una liga """
	# Obtenemos el usuario
	usuario = request.user

	liga = request.session['liga_actual']
	equipo_propio = request.session['equipo_propio']

	# Obtenemos los equipos que juegan en la liga
	equipos = liga.equipo_set.all()

	activada = liga.activada()

	# Cargamos la plantilla con los parametros y la devolvemos
	d = {
		"liga" : liga,
		"equipos" : equipos,
		"activada" : activada,
		"equipo_propio" : equipo_propio,
		}
	return generarPagina(request, "juego/equipos/listar_liga.html", d)

########################################################################

